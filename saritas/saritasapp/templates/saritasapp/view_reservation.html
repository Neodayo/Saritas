{% extends 'saritasapp/base.html' %}
{% load static %}

{% block title %}Reservation Management | Sarita's{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/view_reservation.css' %}">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="reservation-container">
    <h2 class="gold-heading">Reservation Management</h2>

    <div class="filter-container">
        <div class="status-filter">
            <strong class="filter-label">Filter by Status:</strong>
            <a href="?status=all" class="status-badge status-all {% if status == 'all' %}active{% endif %}">
                <i class="fas fa-list"></i> All
            </a>
            {% for choice in status_choices %}
            <a href="?status={{ choice.0 }}" class="status-badge status-{{ choice.0 }} {% if status == choice.0 %}active{% endif %}">
                <i class="status-icon fas fa-{% if choice.0 == 'pending' %}clock{% elif choice.0 == 'approved' %}check-circle{% elif choice.0 == 'rejected' %}times-circle{% else %}calendar-check{% endif %}"></i>
                {{ choice.1 }}
            </a>
            {% endfor %}
        </div>
    </div>

    {% if reservations %}
    <div class="table-responsive">
        <table class="reservation-table display nowrap" id="reservationTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Customer</th>
                    <th>Item</th>
                    <th>Dates</th>
                    <th>Quantity</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for reservation in reservations %}
                <tr>
                    <td>#{{ reservation.id }}</td>
                    <td>
                        <div class="customer-info">
                            <div class="customer-name">{{ reservation.customer.user.get_full_name }}</div>
                            <div class="customer-email">{{ reservation.customer.user.email }}</div>
                        </div>
                    </td>
                    <td>
                        <div class="item-container">
                            {% if reservation.item.image %}
                            <img src="{{ reservation.item.image.url }}" alt="{{ reservation.item.name }}" class="item-thumb">
                            {% endif %}
                            <div class="item-details">
                                <div class="item-name">{{ reservation.item.name }}</div>
                                <div class="item-category">{{ reservation.item.category.name }}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="date-range">
                            {{ reservation.reservation_date|date:"M d" }} - 
                            {{ reservation.return_date|date:"M d" }}
                        </div>
                        <div class="duration">{{ reservation.duration_days }} days</div>
                    </td>
                    <td class="quantity">{{ reservation.quantity }}</td>
                    <td class="total">â‚±{{ reservation.total_cost|floatformat:2 }}</td>
                    <td>
                        <div class="status-container">
                            <span class="status-badge status-{{ reservation.status }}">
                                {{ reservation.get_status_display }}
                            </span>
                            {% if reservation.approved_by %}
                            <div class="approver">By: {{ reservation.approved_by.get_full_name }}</div>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            {% if reservation.status == 'pending' %}
                            <form method="post" action="{% url 'saritasapp:update_reservation' reservation.id 'approve' %}">
                                {% csrf_token %}
                                <button type="submit" class="action-btn btn-approve">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                            </form>
                            <form method="post" action="{% url 'saritasapp:update_reservation' reservation.id 'reject' %}">
                                {% csrf_token %}
                                <button type="submit" class="action-btn btn-reject">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </form>
                            {% elif reservation.status == 'approved' %}
                            <form method="post" action="{% url 'saritasapp:update_reservation' reservation.id 'complete' %}">
                                {% csrf_token %}
                                <button type="submit" class="action-btn btn-complete">
                                    <i class="fas fa-check-double"></i> Complete
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-calendar-check"></i>
        <h4>No Reservations Found</h4>
        <p>There are currently no reservations matching your criteria.</p>
    </div>
    {% endif %}
</div>

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script>
    $(document).ready(function () {
        $('#reservationTable').DataTable({
            scrollX: true,
            responsive: true,
            pageLength: 10,
            dom: '<"top"<"filter-container"f>>rt<"bottom"<"table-info"lip>><"clear">',
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search reservations...",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                paginate: {
                    previous: '<i class="fas fa-chevron-left"></i>',
                    next: '<i class="fas fa-chevron-right"></i>'
                }
            },
            initComplete: function() {
                $('.dataTables_filter input').addClass('search-input');
            }
        });
    });
</script>
{% endblock %}
