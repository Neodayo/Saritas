{% extends 'customerapp/base.html' %}
{% load static %}

{% block title %}Reserve {{ inventory.name }} | Saritas{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reservations.css' %}">
<style>
    .reservation-card { max-width: 1200px; margin: 0 auto; }
    .item-image { max-height: 400px; object-fit: contain; }
    .summary-card { background-color: #f8f9fa; }
    .invalid-feedback { display: block; color: #dc3545; }
    .fee-display { font-size: 1.2rem; font-weight: bold; }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="reservation-card card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Reserve: {{ inventory.name }}</h2>
        </div>

        <div class="card-body">
            <div class="row">
                <!-- Item Image Column -->
                <div class="col-md-5">
                    <div class="item-image-container text-center mb-4">
                        {% if inventory.image %}
                            <img src="{{ inventory.image.url }}" alt="{{ inventory.name }}" class="img-fluid rounded item-image">
                        {% else %}
                            <img src="{% static 'images/default-placeholder.png' %}" alt="No image available" class="img-fluid rounded item-image">
                        {% endif %}
                    </div>

                    <div class="item-details">
                        <h4 class="text-primary">{{ inventory.name }}</h4>
                        <p class="text-muted">{{ inventory.category.name }}</p>

                        {% if inventory.color %}
                        <div class="item-meta mb-2">
                            <span class="badge bg-info me-2">Color: {{ inventory.color.name }}</span>
                        </div>
                        {% endif %}

                        <div class="availability mb-3">
                            <span class="badge {% if inventory.calculated_quantity > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                {% if inventory.calculated_quantity > 0 %}
                                    {{ inventory.calculated_quantity }} available
                                {% else %}
                                    Out of stock
                                {% endif %}
                            </span>
                        </div>

                        <div class="pricing">
                            <h5 class="text-success">₱{{ inventory.rental_price }} <small class="text-muted">is rental price</small></h5>
                            <p class="text-muted mb-1">Deposit: ₱{{ inventory.deposit_price|default:"0.00" }}</p>
                        </div>
                    </div>
                </div>

                <!-- Reservation Form Column -->
                <div class="col-md-7">
                    {% if messages %}
                    <div class="alert-container mb-4">
                        {% for message in messages %}
                        <div class="alert alert-dismissible {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <form method="post" class="reservation-form needs-validation" novalidate>
                        {% csrf_token %}

                        <!-- Size Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Select Size*</label>
                            {% for radio in form.inventory_size %}
                                <div class="form-check mb-2">
                                    {{ radio.tag }}
                                    <label class="form-check-label" for="{{ radio.id_for_label }}">
                                        {{ radio.choice_label }}
                                    </label>
                                </div>
                            {% endfor %}
                            {% if form.inventory_size.errors %}
                                <div class="invalid-feedback d-block">
                                    {{ form.inventory_size.errors.as_text }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Reservation Fee Information -->
                        <div class="card mb-4 summary-card">
                            <div class="card-body">
                                <h5 class="card-title">Reservation Summary</h5>
                                <hr>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Reservation Fee:</span>
                                    <span class="fee-display text-primary">₱500.00</span>
                                </div>
                                <small class="text-muted">
                                    This fee will be applied to your rental when you pick up the item.
                                </small>
                                <div class="alert alert-info mt-3">
                                    <i class="bi bi-info-circle"></i> You have 24 hours to pick up the item after reservation.
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'customerapp:item_detail' inventory.encrypted_id %}" class="btn btn-outline-secondary me-md-2">
                                <i class="bi bi-arrow-left"></i> Back to Item
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-calendar-check"></i> Reserve Now (₱500)
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('.needs-validation');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    }, false);
});
</script>
{% endblock %}
